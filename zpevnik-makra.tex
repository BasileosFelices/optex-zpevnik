%---Makra pro zpěvníček-------------------------------

\input cavantga

\font\bigfont=pagk8z at32pt
\font\smaller=pagk8z at24pt

\font\mya=pagk8z scaled \magstep2
\font\myb=pagk8z scaled \magstep1


%pro debuging	
\def\boxed#1{\hbox{\vrule\vbox{\hrule\hbox{#1}\hrule}\vrule}}


\parindent=0 pt

%čítač slok
\newcount\verscnt


%---Pomocná makra------------------------------------
\def\newpage{\vfil \break}
\def\centerH#1{\hbox to \hsize{\hss #1 \hss}}
\def\donothing{}


%---Zpěvník------------------------------------------
%TODO: nastavení tisku - velikost stránky, velikost okrajů, ...
%TODO: titulek, podtitulek, autor, obrázek?
%TODO: vypnout číslování

\nopagenumbers

\def\booktitle#1\par{\vbox to 0.25\vsize{}\centerH{\bigfont #1}\bigskip\nobreak}

\def\bookauthor#1\par{\centerH{\smaller #1}}

\def\songs{\newpage \footline={\hss\tenrm\folio\hss}}


%---Píseň--------------------------------------------
\def\beginsong{\newpage \verscnt 1\relax}

\def\title#1{{\mya #1}\par\bigskip\nobreak
	\immediate\write\writef{\string\tocline{#1}{\the\pageno}}
}

\def\author#1{{\myb #1}\par\bigskip}


%---Předehra-----------------------------------------
\def\intro#1\par{{\it Intro: } #1 \medskip}


%---Refrén-------------------------------------------
%TODO: refrén s parametrem/bez parametru
%TODO: podruhé vložený refrain buď vložit celý, nebo jen první řádek a ...?
%\def\refrain{{\bf Ref.}\bigskip}

{\catcode`\^^M=13
\gdef\beginrefrain{\begingroup \catcode`\^^M=13
\let^^M=\par
\bf \noindent \hbox to 0pt{\hss Ref:\kern.2em}\ignorespaces}}

\def\endrefrain{\endgroup\bigskip}

\def\refrain{{\bf Ref.}}


%---Sloky--------------------------------------------
%TODO: Odsazení čísel slok
{\catcode`\^^M=13
\gdef\beginverse{\begingroup \catcode`\^^M=13
\let^^M=\par
\par 	\noindent \hbox to 0pt{\hss \the\verscnt \kern.2em}\ignorespaces}}

\def\endverse{\bigskip\endgroup \advance\verscnt 1\relax}


%---Vysázení akordů----------------------------------
%TODO: doupravit odsazení - zarovnat se začátkem písmene, ke kterému patří?
%TODO: bug-akord na začátku řádky?
%\def\chord#1{{\it \kern-.75em\lower-1em\hbox{#1}}}
\def\chord#1{\noindent\raise 12pt \hbox to 0pt{\kern0pt {\it #1} \hss}}


%---Repetice-----------------------------------------
%TODO: Jak s volitelnými parametry?
%TODO: Přidat účaří, zarovnat s textem
\catcode`\|=13

{
\catcode`\^^M=13
\gdef|:#1:|#2^^M{\noindent\drawl{\bi #1}\drawr\if:#2: {} \else {\bi \hskip 5pt  #2x} \fi}}

\def\lrepsign{\pdfliteral{q
.5 w
2 10 m
0 8 l	%horní šikmá čára
0 2 l 	%kratší vertikální čára
2 0 l	%dolní šikmá čára
S
1 9 m
1 1 l	%delší přepažující vertikální čára
S
2 7 m
2 6 l	%horní bod
S
2 4 m
2 3 l	%spodní bod
S
Q}}

\def\rrepsign{\pdfliteral{q
-1 0 0 1 0 0 cm		%zrcadlení podle osy y
\lrepsign
Q}}

\newcount\lrepsignnb
\setbox0=\hbox to 3pt{\vbox to 10pt{\vss\lrepsign}\hss}
\pdfxform 0 \lrepsignnb=\pdflastxform
\def\drawl{\pdfrefxform\lrepsignnb}

\newcount\rrepsignnb
\setbox0=\hbox to 3pt{\hss \vbox to 10pt{\vss\rrepsign}}
\pdfxform 0 \rrepsignnb=\pdflastxform
\def\drawr{\pdfrefxform\rrepsignnb}


%---Obsah-------------------------------------------------

\newread\readf
\newwrite\writef

\immediate\openout\writef=toc.tex

\def\tocline#1#2{#1 \dotfill #2\par}

\def\readline{
\immediate\read\readf to \oneline
\oneline
\readall}

\def\readtoc{
  \immediate\closeout\writef
  \newpage
  \nopagenumbers
  {\bf Obsah:\par\bigskip}
  \immediate\openin\readf=toc.tex
  \readall
  \immediate\closein\readf}

\def\readall{\ifeof\readf 
		\let\next=\donothing
	\else 
		\let\next=\readline 
	\fi 
	\next}

